name: CI

on:
  push:
    branches: [{{ default_branch | default: 'main' }}, develop]
  pull_request:
    branches: [{{ default_branch | default: 'main' }}]

{{#if use_env_vars}}
env:
{{#each env_vars}}
  {{ this.name }}: {{ this.value }}
{{/each}}
{{/if}}

jobs:
  lint:
    name: Lint
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      {{#if language == 'typescript' || language == 'javascript'}}
      - uses: actions/setup-node@v4
        with:
          node-version: '{{ node_version | default: "20" }}'
          cache: 'npm'

      - run: npm ci
      - run: npm run lint
      {{#if use_typescript}}
      - run: npm run typecheck
      {{/if}}
      {{/if}}

      {{#if language == 'python'}}
      - uses: actions/setup-python@v5
        with:
          python-version: '{{ python_version | default: "3.12" }}'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install ruff mypy

      - run: ruff check .
      - run: mypy src/
      {{/if}}

      {{#if language == 'go'}}
      - uses: actions/setup-go@v5
        with:
          go-version: '{{ go_version | default: "1.22" }}'

      - run: go vet ./...
      - run: golangci-lint run
      {{/if}}

  test:
    name: Test
    runs-on: ubuntu-latest
    {{#if needs_lint}}
    needs: lint
    {{/if}}

    {{#if use_services}}
    services:
      {{#if database == 'postgresql'}}
      postgres:
        image: postgres:16
        env:
          POSTGRES_USER: test
          POSTGRES_PASSWORD: test
          POSTGRES_DB: test
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
      {{/if}}
      {{#if database == 'mysql'}}
      mysql:
        image: mysql:8
        env:
          MYSQL_ROOT_PASSWORD: test
          MYSQL_DATABASE: test
        ports:
          - 3306:3306
        options: >-
          --health-cmd "mysqladmin ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
      {{/if}}
      {{#if use_redis}}
      redis:
        image: redis:7
        ports:
          - 6379:6379
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
      {{/if}}
    {{/if}}

    steps:
      - uses: actions/checkout@v4

      {{#if language == 'typescript' || language == 'javascript'}}
      - uses: actions/setup-node@v4
        with:
          node-version: '{{ node_version | default: "20" }}'
          cache: 'npm'

      - run: npm ci
      - run: npm test
        {{#if use_services}}
        env:
          DATABASE_URL: {{ database_url }}
        {{/if}}
      {{/if}}

      {{#if language == 'python'}}
      - uses: actions/setup-python@v5
        with:
          python-version: '{{ python_version | default: "3.12" }}'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e '.[dev]'

      - run: pytest --cov --cov-report=xml
        {{#if use_services}}
        env:
          DATABASE_URL: {{ database_url }}
        {{/if}}

      - uses: codecov/codecov-action@v4
        if: ${{ !cancelled() }}
        with:
          token: ${{ secrets.CODECOV_TOKEN }}
      {{/if}}

      {{#if language == 'go'}}
      - uses: actions/setup-go@v5
        with:
          go-version: '{{ go_version | default: "1.22" }}'

      - run: go test -race -coverprofile=coverage.out ./...
        {{#if use_services}}
        env:
          DATABASE_URL: {{ database_url }}
        {{/if}}

      - uses: codecov/codecov-action@v4
        if: ${{ !cancelled() }}
        with:
          files: coverage.out
      {{/if}}

  build:
    name: Build
    runs-on: ubuntu-latest
    needs: test
    {{#if use_docker}}
    steps:
      - uses: actions/checkout@v4

      - uses: docker/setup-buildx-action@v3

      - uses: docker/build-push-action@v5
        with:
          context: .
          push: false
          tags: {{ project_name }}:${{ github.sha }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
    {{else}}
    steps:
      - uses: actions/checkout@v4

      {{#if language == 'typescript'}}
      - uses: actions/setup-node@v4
        with:
          node-version: '{{ node_version | default: "20" }}'
          cache: 'npm'

      - run: npm ci
      - run: npm run build
      {{/if}}

      {{#if language == 'go'}}
      - uses: actions/setup-go@v5
        with:
          go-version: '{{ go_version | default: "1.22" }}'

      - run: go build -o bin/{{ project_name }} ./cmd/{{ project_name }}
      {{/if}}
    {{/if}}
